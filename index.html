<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Perencanaan Biktren</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase modules to window so React can access them
        window.firebaseModules = { 
            initializeApp, 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            signOut, 
            onAuthStateChanged, 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            deleteDoc, 
            query, 
            where, 
            onSnapshot 
        };
    </script>

    <!-- PapaParse & Tailwind & Icons -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Marked for Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glass-card { background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .glass-effect { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e2e8f0; }
        .calendar-cell { background-color: white; min-height: 100px; }
        .calendar-cell:hover { background-color: #f8fafc; }
        .mini-calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e2e8f0; font-size: 0.7rem; }
        .mini-calendar-cell { background-color: white; height: 30px; display: flex; align-items: center; justify-content: center; position: relative; }
        .has-event-dot { width: 4px; height: 4px; background-color: #3073F1; border-radius: 50%; position: absolute; bottom: 2px; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .truncate-cell { max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .menu-item:hover { transform: translateX(4px); }
        .menu-item.active { background: #ffffff; color: #3073F1; font-weight: 700; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .mobile-nav-item.active { color: #3073F1; }
        .mobile-nav-item.active .icon-container { transform: translateY(-20px); background-color: #3073F1; color: white; border: 4px solid #f1f5f9; }
        
        /* Chat Styles */
        .chat-bubble { max-width: 80%; padding: 12px 16px; border-radius: 1rem; position: relative; }
        .chat-user { background-color: #3073F1; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-ai { background-color: #f1f5f9; color: #1e293b; align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid #e2e8f0; }
        .chat-markdown ul { list-style-type: disc; margin-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .chat-markdown ol { list-style-type: decimal; margin-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .chat-markdown p { margin-bottom: 0.5rem; }
        .chat-markdown strong { font-weight: 700; }
        .typing-dot { width: 6px; height: 6px; background-color: #cbd5e1; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes modalEnter { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-modal-enter { animation: modalEnter 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- FIREBASE CONFIGURATION (PENTING: ISI INI UNTUK NETLIFY) ---
        // Jika di deploy ke Netlify, hapus logika 'typeof __firebase_config' dan masukkan object config Anda langsung.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // CONTOH (Ganti dengan data dari Firebase Console):
            // apiKey: "AIzaSy...",
            // authDomain: "biktren-app.firebaseapp.com",
            // projectId: "biktren-app",
            // storageBucket: "biktren-app.appspot.com",
            // messagingSenderId: "12345...",
            // appId: "1:12345..."
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'biktren-app';
        
        let auth, db, provider;
        
        // Initialize Firebase services safely
        if (window.firebaseModules && Object.keys(firebaseConfig).length > 0) {
            const { initializeApp, getAuth, getFirestore, GoogleAuthProvider } = window.firebaseModules;
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            provider = new GoogleAuthProvider();
            // Add scope for Gemini AI (Vertex AI/Generative Language)
            provider.addScope('https://www.googleapis.com/auth/generative-language.retriever.readonly');
            provider.addScope('https://www.googleapis.com/auth/cloud-platform'); 
        }

        // --- UTILS & CONSTANTS ---
        const DEFAULT_DPPK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQsyhdflwwzu6_vAeJVMO8JccuK_riBbDa45q1m6xWGe0Bq5Ol-AEwzuCULArWA-J_8JoSlqWH8yoL4/pub?gid=0&single=true&output=csv";
        const DEFAULT_RAB = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQsyhdflwwzu6_vAeJVMO8JccuK_riBbDa45q1m6xWGe0Bq5Ol-AEwzuCULArWA-J_8JoSlqWH8yoL4/pub?gid=774580455&single=true&output=csv";
        const currentYear = new Date().getFullYear();
        const monthOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

        const formatRupiah = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num || 0);
        const getMonthName = (idx) => monthOptions[idx] || "";
        
        const parseIndonesianDate = (str) => {
            if (!str) return null;
            const monthMap = { 'januari': 'January', 'februari': 'February', 'maret': 'March', 'april': 'April', 'mei': 'May', 'juni': 'June', 'juli': 'July', 'agustus': 'August', 'september': 'September', 'oktober': 'October', 'november': 'November', 'desember': 'December', 'jan': 'Jan', 'feb': 'Feb', 'mar': 'Mar', 'apr': 'Apr', 'mei': 'May', 'jun': 'Jun', 'jul': 'Jul', 'agu': 'Aug', 'sep': 'Sep', 'okt': 'Oct', 'nov': 'Nov', 'des': 'Dec' };
            let cleanStr = str.trim();
            if (cleanStr.match(/^\d{4}-\d{2}-\d{2}$/)) return new Date(cleanStr);
            const parts = cleanStr.split(' ');
            const translatedParts = parts.map(part => monthMap[part.toLowerCase()] || part);
            const d = new Date(translatedParts.join(' '));
            return isNaN(d) ? null : d;
        };

        const formatHijri = (date) => {
            try { return new Intl.DateTimeFormat('id-ID-u-ca-islamic', { day: 'numeric', month: 'long' }).format(date); } catch (e) { return ""; }
        };

        const getExecutionCount = (waktuStr) => {
            if (!waktuStr) return 0;
            return waktuStr.split(',').map(s => s.trim()).filter(s => s.length > 0).length;
        };

        // --- SHARED COMPONENTS ---
        const StatusBadge = ({ type }) => (
            <span className={`px-2 py-1 rounded-full text-xs font-semibold border ${type === 'Rutin' ? 'bg-blue-100 text-blue-700 border-blue-200' : type === 'Pengadaan' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-purple-100 text-purple-700 border-purple-200'}`}>{type || 'Umum'}</span>
        );

        const LengthMenu = ({ value, onChange }) => (
            <div className="flex items-center gap-2 mb-4 bg-white p-2 rounded-lg border border-slate-200 shadow-sm w-fit">
                <span className="text-xs font-medium text-slate-600">Tampilkan</span>
                <select value={value} onChange={onChange} className="border border-slate-300 rounded-md py-1 px-2 text-xs font-bold text-indigo-600 bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none cursor-pointer">
                    {[25, 50, 100, 250, 500, 1000].map(v => <option key={v} value={v}>{v}</option>)}
                </select>
                <span className="text-xs font-medium text-slate-600">data</span>
            </div>
        );

        const Pagination = ({ totalItems, itemsPerPage, currentPage, onPageChange }) => {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (totalItems === 0) return null;
            const start = (currentPage - 1) * itemsPerPage + 1;
            const end = Math.min(currentPage * itemsPerPage, totalItems);
            
            return (
                <div className="flex flex-col sm:flex-row justify-between items-center p-4 border-t border-slate-200 bg-white gap-4">
                    <div className="text-xs text-slate-500">Menampilkan <span className="font-bold text-slate-700">{start}</span> - <span className="font-bold text-slate-700">{end}</span> dari <span className="font-bold text-slate-700">{totalItems}</span></div>
                    <div className="flex items-center gap-2">
                        <button onClick={() => onPageChange(Math.max(1, currentPage - 1))} disabled={currentPage === 1} className="p-2 rounded-lg border border-slate-200 hover:bg-slate-50 disabled:opacity-30"><i data-lucide="chevron-left" className="w-4 h-4"></i></button>
                        <span className="px-3 py-1.5 text-xs font-bold text-indigo-700 bg-indigo-50 rounded-lg border border-indigo-100">Hal. {currentPage} / {totalPages}</span>
                        <button onClick={() => onPageChange(Math.min(totalPages, currentPage + 1))} disabled={currentPage === totalPages} className="p-2 rounded-lg border border-slate-200 hover:bg-slate-50 disabled:opacity-30"><i data-lucide="chevron-right" className="w-4 h-4"></i></button>
                    </div>
                </div>
            );
        };

        const MiniStats = ({ programCount, activityCount, totalBudget, type }) => (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 animate-fade-in">
                <div className="p-4 rounded-xl shadow-lg flex items-center justify-between" style={{ background: 'linear-gradient(135deg, #3073F1 0%, #4a84f3 100%)' }}>
                    <div><p className="text-xs font-semibold text-blue-100 uppercase">Total Program</p><h3 className="text-xl font-bold text-white">{programCount}</h3></div>
                    <div className="p-3 rounded-lg bg-white/20 text-white backdrop-blur-sm"><i data-lucide="layers" className="w-5 h-5"></i></div>
                </div>
                <div className="p-4 rounded-xl shadow-lg flex items-center justify-between" style={{ background: 'linear-gradient(135deg, #0BA875 0%, #20c58e 100%)' }}>
                    <div><p className="text-xs font-semibold text-emerald-100 uppercase">Total Kegiatan {type === 'RAB' ? '(Unik)' : ''}</p><h3 className="text-xl font-bold text-white">{activityCount}</h3></div>
                    <div className="p-3 rounded-lg bg-white/20 text-white backdrop-blur-sm"><i data-lucide="activity" className="w-5 h-5"></i></div>
                </div>
                <div className="p-4 rounded-xl shadow-lg flex items-center justify-between" style={{ background: 'linear-gradient(135deg, #E78B09 0%, #f5a636 100%)' }}>
                    <div><p className="text-xs font-semibold text-amber-100 uppercase">Total Anggaran</p><h3 className="text-xl font-bold text-white">{formatRupiah(totalBudget)}</h3></div>
                    <div className="p-3 rounded-lg bg-white/20 text-white backdrop-blur-sm"><i data-lucide="wallet" className="w-5 h-5"></i></div>
                </div>
            </div>
        );

        const StatsTable = ({ title, icon, data, colorClass, countLabel, count }) => (
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                <div className="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                    <div className="flex items-center gap-3"><div className={`p-2 rounded-lg ${colorClass} bg-opacity-20 text-current`}>{icon}</div><h3 className="text-lg font-bold text-slate-800">{title}</h3></div>
                    {countLabel && <span className="text-xs font-bold px-3 py-1.5 bg-white border border-slate-200 rounded-full text-slate-600 shadow-sm">{countLabel}: {count}</span>}
                </div>
                <div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-100 table-fixed"><thead className="bg-slate-50"><tr><th className="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase w-[35%]">Nama</th><th className="px-6 py-3 text-center text-xs font-bold text-slate-500 uppercase w-[12%]">Jml Program</th><th className="px-6 py-3 text-center text-xs font-bold text-slate-500 uppercase w-[12%]">Jml Kegiatan</th><th className="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase w-[20%]">Total Anggaran</th><th className="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase w-[21%]">Persentase</th></tr></thead><tbody className="divide-y divide-slate-100">{data.map((item, idx) => (<tr key={idx} className="hover:bg-slate-50 transition"><td className="px-6 py-4 text-sm font-medium text-slate-800 truncate" title={item.name}>{item.name}</td><td className="px-6 py-4 text-center text-sm text-slate-600">{item.programCount}</td><td className="px-6 py-4 text-center text-sm text-slate-600">{item.activityCount}</td><td className="px-6 py-4 text-right text-sm font-bold text-slate-800">{formatRupiah(item.budget)}</td><td className="px-6 py-4 align-middle"><div className="flex items-center justify-end gap-2"><div className="w-full bg-slate-200 rounded-full h-2 overflow-hidden max-w-[100px]"><div className={`h-full rounded-full ${colorClass.replace('text-', 'bg-')}`} style={{ width: `${item.percentage}%` }}></div></div><span className="text-xs font-medium text-slate-500 w-10 text-right">{item.percentage.toFixed(1)}%</span></div></td></tr>))}</tbody></table></div>
            </div>
        );

        // --- AI CHAT COMPONENT ---
        const AIChatView = ({ dataDPPK, dataRAB, geminiToken }) => {
            const [messages, setMessages] = useState([{ role: 'model', text: 'Halo! Saya asisten AI Biktren. Ada yang bisa saya bantu terkait data program atau RAB?' }]);
            const [input, setInput] = useState(''); const [isLoading, setIsLoading] = useState(false); const messagesEndRef = useRef(null);
            const scrollToBottom = () => messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); useEffect(scrollToBottom, [messages]);

            const callGemini = async (prompt) => {
                const systemPrompt = `Kamu adalah asisten AI untuk "Aplikasi Perencanaan Biktren". Jawab pertanyaan berdasarkan data JSON ini. Data Program (DPPK) Ringkasan: ${JSON.stringify(dataDPPK.slice(0, 100).map(d => ({kegiatan: d.kegiatan, anggaran: d.anggaran, pic: d.pic})))}`;
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${geminiToken}` }, 
                        body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt + "\nUser: " + prompt }] }] })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    return data.candidates[0].content.parts[0].text;
                } catch (e) {
                    throw new Error("Gagal menghubungi AI: " + e.message);
                }
            };

            const handleSend = async (e) => {
                e.preventDefault(); if (!input.trim()) return;
                const userMsg = { role: 'user', text: input };
                setMessages(prev => [...prev, userMsg]); setInput(''); setIsLoading(true);
                try {
                    const replyText = await callGemini(input);
                    setMessages(prev => [...prev, { role: 'model', text: replyText }]);
                } catch (err) { setMessages(prev => [...prev, { role: 'model', text: `Error: ${err.message}` }]); } finally { setIsLoading(false); }
            };

            return (
                <div className="flex flex-col h-full bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"><div className="p-4 border-b border-slate-100 bg-slate-50 font-bold text-slate-700 flex items-center gap-2"><i data-lucide="sparkles" className="w-5 h-5 text-indigo-600"></i> AI Assistant Biktren</div><div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/50">{messages.map((msg, i) => (<div key={i} className={`flex flex-col ${msg.role === 'user' ? 'items-end' : 'items-start'}`}><div className={`chat-bubble ${msg.role === 'user' ? 'chat-user' : 'chat-ai'}`}><div className="chat-markdown" dangerouslySetInnerHTML={{ __html: marked.parse(msg.text) }}></div></div><span className="text-[10px] text-slate-400 mt-1 mx-1">{msg.role === 'user' ? 'Anda' : 'AI Biktren'}</span></div>))}{isLoading && <div className="flex items-start"><div className="chat-bubble chat-ai flex gap-1"><div className="typing-dot"></div><div className="typing-dot"></div><div className="typing-dot"></div></div></div>}<div ref={messagesEndRef} /></div><form onSubmit={handleSend} className="p-4 border-t border-slate-200 bg-white flex gap-2"><input type="text" value={input} onChange={e => setInput(e.target.value)} placeholder="Tanya tentang program..." className="flex-1 border border-slate-300 rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" disabled={isLoading} /><button type="submit" disabled={isLoading} className="bg-indigo-600 text-white p-2 rounded-xl hover:bg-indigo-700 disabled:opacity-50 transition"><i data-lucide="send" className="w-5 h-5"></i></button></form></div>
            );
        };

        // --- LOGIN VIEW (UPDATED WITH BYPASS & HARDCODED ADMIN) ---
        const LoginView = ({ onLoginSuccess }) => {
            const [errorMsg, setErrorMsg] = useState('');
            const [isLoggingIn, setIsLoggingIn] = useState(false);
            const [showBypass, setShowBypass] = useState(false);
            const { signInWithPopup, GoogleAuthProvider, signOut, collection, getDocs } = window.firebaseModules;

            const handleGoogleLogin = async () => {
                setIsLoggingIn(true);
                setErrorMsg('');
                setShowBypass(false);
                
                try {
                    const result = await signInWithPopup(auth, provider);
                    const user = result.user;
                    const credential = GoogleAuthProvider.credentialFromResult(result);
                    const accessToken = credential.accessToken;

                    const PRIMARY_EMAIL = "achmadnaufalbaidawi@gmail.com";

                    if (user.email.toLowerCase() === PRIMARY_EMAIL.toLowerCase()) {
                        onLoginSuccess(user, accessToken);
                        return;
                    }

                    const whitelistCol = collection(db, 'artifacts', appId, 'public', 'data', 'email_whitelist');
                    const snapshot = await getDocs(whitelistCol);
                    const allowedEmails = snapshot.docs.map(doc => doc.data().email.toLowerCase());

                    if (allowedEmails.length === 0) {
                        onLoginSuccess(user, accessToken);
                    } else if (allowedEmails.includes(user.email.toLowerCase())) {
                        onLoginSuccess(user, accessToken);
                    } else {
                        await signOut(auth);
                        setErrorMsg(`Akses Ditolak: Email ${user.email} tidak terdaftar dalam whitelist.`);
                    }
                } catch (error) {
                    console.error("Login Failed:", error);
                    let msg = "Login Gagal: " + error.message;
                    
                    if (error.code === 'auth/unauthorized-domain') {
                        msg = `Domain ini tidak diizinkan oleh Firebase. Tambahkan domain ini di Console > Auth > Settings.`;
                        setShowBypass(true); 
                    } else if (error.code === 'auth/network-request-failed') {
                        msg = "Masalah koneksi internet.";
                        setShowBypass(true);
                    }

                    setErrorMsg(msg);
                } finally {
                    setIsLoggingIn(false);
                }
            };

            const handleBypassLogin = () => {
                const mockUser = {
                    email: "achmadnaufalbaidawi@gmail.com",
                    displayName: "Super Admin (Dev)",
                    uid: "dev-bypass-uid"
                };
                onLoginSuccess(mockUser, "dummy-token-for-dev");
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
                        <div className="mb-6 flex justify-center text-indigo-600"><i data-lucide="shield-check" className="w-16 h-16"></i></div>
                        <h1 className="text-2xl font-bold text-slate-800 mb-2">Login Admin Biktren</h1>
                        <p className="text-slate-500 text-sm mb-8">Silakan login menggunakan akun Google yang terdaftar untuk mengakses sistem.</p>
                        
                        {errorMsg && (
                            <div className="mb-4 p-3 bg-red-50 text-red-600 text-xs rounded-lg border border-red-100 text-left">
                                <div className="flex items-center gap-2 font-bold mb-1"><i data-lucide="alert-circle" className="w-4 h-4 shrink-0"></i> Error Login</div>
                                {errorMsg}
                            </div>
                        )}
                        
                        <button onClick={handleGoogleLogin} disabled={isLoggingIn} className="w-full flex items-center justify-center gap-3 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-bold py-3 px-4 rounded-xl transition shadow-sm disabled:opacity-50">
                            {isLoggingIn ? <span className="loading-spinner w-5 h-5 border-2 border-slate-400 border-t-slate-800"></span> : <><svg className="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z"/><path fill="#EA4335" d="M12 4.63c1.61 0 3.06.56 4.21 1.64l3.16-3.16C17.45 1.09 14.97 0 12 0 7.7 0 3.99 2.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Login dengan Google</>}
                        </button>

                        {showBypass && (
                            <div className="mt-4 pt-4 border-t border-slate-100 animate-fade-in">
                                <p className="text-xs text-slate-400 mb-2">Mode Pengembang (Darurat)</p>
                                <button onClick={handleBypassLogin} className="w-full py-2 bg-slate-800 text-white text-xs font-bold rounded-lg hover:bg-slate-700 transition">
                                    Masuk sebagai Super Admin (Bypass)
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const WhitelistSettings = () => {
            const [email, setEmail] = useState('');
            const [emails, setEmails] = useState([]);
            const { collection, addDoc, getDocs, deleteDoc, doc, onSnapshot } = window.firebaseModules;
            
            useEffect(() => {
                const unsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'email_whitelist'), (snap) => {
                    setEmails(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, []);

            const handleAdd = async () => {
                if (!email) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'email_whitelist'), { email: email.toLowerCase(), addedAt: new Date().toISOString() });
                setEmail('');
            };

            const handleDelete = async (id) => {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'email_whitelist', id));
            };

            return (
                <div className="mt-8 pt-6 border-t border-slate-100">
                    <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="shield" className="w-5 h-5 text-indigo-600"></i> Email Whitelist (Akses Login)</h3>
                    <div className="flex gap-2 mb-4"><input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="tambah.email@gmail.com" className="flex-1 border border-slate-300 rounded-lg px-3 py-2" /><button onClick={handleAdd} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Tambah</button></div>
                    <div className="bg-slate-50 rounded-lg border border-slate-200 overflow-hidden"><table className="min-w-full divide-y divide-slate-200"><thead className="bg-slate-100"><tr><th className="px-4 py-2 text-left text-xs font-bold text-slate-500">Email</th><th className="px-4 py-2 text-right text-xs font-bold text-slate-500">Aksi</th></tr></thead><tbody className="divide-y divide-slate-200">{emails.map(e => (<tr key={e.id}><td className="px-4 py-2 text-sm text-slate-700">{e.email}</td><td className="px-4 py-2 text-right"><button onClick={() => handleDelete(e.id)} className="text-red-500 hover:text-red-700 text-xs font-bold">Hapus</button></td></tr>))}</tbody></table></div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [geminiToken, setGeminiToken] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            
            // Reusing Data State & Logic
            const [config, setConfig] = useState({ dppk: localStorage.getItem('dppk_url') || DEFAULT_DPPK, rab: localStorage.getItem('rab_url') || DEFAULT_RAB });
            const [searchTerm, setSearchTerm] = useState('');
            const [loading, setLoading] = useState(true);
            const [dataDPPK, setDataDPPK] = useState([]);
            const [dataRAB, setDataRAB] = useState([]);
            const [selectedUnit, setSelectedUnit] = useState('');
            const [selectedPIC, setSelectedPIC] = useState('');
            const [selectedWilayah, setSelectedWilayah] = useState('');
            const [selectedMonth, setSelectedMonth] = useState('');
            const [selectedActivity, setSelectedActivity] = useState(null);
            const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);

            useEffect(() => {
                const loadData = async () => {
                    try {
                        const fetchCSV = (url) => new Promise((resolve, reject) => Papa.parse(url, { download: true, header: true, skipEmptyLines: true, complete: res => resolve(res.data), error: reject }));
                        const [dppkRes, rabRes] = await Promise.all([fetchCSV(config.dppk), fetchCSV(config.rab)]);
                        
                        // Process Data (Simplified for brevity, same logic as before)
                        setDataDPPK(dppkRes.map(item => ({...item, anggaran: parseInt(String(item['anggaran']).replace(/[^0-9]/g, '')) || 0}))); // Simplified mapping
                        setDataRAB(rabRes.map(item => ({...item, total: parseInt(String(item['total biaya']).replace(/[^0-9]/g, '')) || 0})));
                        setLoading(false);
                    } catch (e) { console.error(e); }
                };
                if (user) loadData(); // Only load if logged in
            }, [config, user]);

            if (!user) {
                return <LoginView onLoginSuccess={(u, token) => { setUser(u); setGeminiToken(token); }} />;
            }

            // Get Unique Values for Filters
            const uniqueUnits = Array.from(new Set([...dataDPPK.map(i => i.unit_kerja), ...dataRAB.map(i => i.unit_kerja)])).filter(Boolean).sort();
            const uniquePICs = Array.from(new Set([...dataDPPK.map(i => i.pic), ...dataRAB.map(i => i.pic)])).filter(Boolean).sort();
            const uniqueWilayahs = Array.from(new Set([...dataDPPK.map(i => i.wilayah_kerja), ...dataRAB.map(i => i.wilayah_kerja)])).filter(Boolean).sort();

            return (
                <div className="min-h-screen bg-slate-50 font-sans">
                     <div className="flex h-screen overflow-hidden">
                        <aside className={`bg-slate-900 text-white flex flex-col transition-all duration-300 ${isSidebarCollapsed ? 'w-20' : 'w-72'}`}>
                            <div className="p-4 font-bold text-xl border-b border-slate-800 flex justify-between items-center">
                                {!isSidebarCollapsed && <span>Admin Biktren</span>}
                                <button onClick={() => setIsSidebarCollapsed(!isSidebarCollapsed)} className="p-1 rounded hover:bg-slate-800">
                                    <i data-lucide={isSidebarCollapsed ? "chevron-right" : "chevron-left"} className="w-5 h-5"></i>
                                </button>
                            </div>
                            <nav className="flex-1 p-4 space-y-2">
                                <button onClick={() => setActiveTab('dashboard')} className={`flex items-center gap-3 w-full text-left px-4 py-3 rounded-lg transition ${activeTab==='dashboard'?'bg-indigo-600':'hover:bg-slate-800'}`}><i data-lucide="layout-dashboard" className="w-5 h-5"></i>{!isSidebarCollapsed && <span>Dashboard</span>}</button>
                                <button onClick={() => setActiveTab('ai-chat')} className={`flex items-center gap-3 w-full text-left px-4 py-3 rounded-lg transition ${activeTab==='ai-chat'?'bg-indigo-600':'hover:bg-slate-800'}`}><i data-lucide="sparkles" className="w-5 h-5 text-yellow-400"></i>{!isSidebarCollapsed && <span>AI Assistant</span>}</button>
                                <button onClick={() => setActiveTab('dppk')} className={`flex items-center gap-3 w-full text-left px-4 py-3 rounded-lg transition ${activeTab==='dppk'?'bg-indigo-600':'hover:bg-slate-800'}`}><i data-lucide="list" className="w-5 h-5"></i>{!isSidebarCollapsed && <span>Data DPPK</span>}</button>
                                <button onClick={() => setActiveTab('monthly')} className={`flex items-center gap-3 w-full text-left px-4 py-3 rounded-lg transition ${activeTab==='monthly'?'bg-indigo-600':'hover:bg-slate-800'}`}><i data-lucide="book-open" className="w-5 h-5"></i>{!isSidebarCollapsed && <span>Rincian Bulanan</span>}</button>
                                <button onClick={() => setActiveTab('rab')} className={`flex items-center gap-3 w-full text-left px-4 py-3 rounded-lg transition ${activeTab==='rab'?'bg-indigo-600':'hover:bg-slate-800'}`}><i data-lucide="shopping-bag" className="w-5 h-5"></i>{!isSidebarCollapsed && <span>Rincian RAB</span>}</button>
                                <button onClick={() => setActiveTab('calendar')} className={`flex items-center gap-3 w-full text-left px-4 py-3 rounded-lg transition ${activeTab==='calendar'?'bg-indigo-600':'hover:bg-slate-800'}`}><i data-lucide="calendar" className="w-5 h-5"></i>{!isSidebarCollapsed && <span>Kalender</span>}</button>
                                <button onClick={() => setActiveTab('setting')} className={`flex items-center gap-3 w-full text-left px-4 py-3 rounded-lg transition ${activeTab==='setting'?'bg-indigo-600':'hover:bg-slate-800'}`}><i data-lucide="settings" className="w-5 h-5"></i>{!isSidebarCollapsed && <span>Pengaturan</span>}</button>
                            </nav>
                            <div className="p-4 border-t border-slate-800">
                                {!isSidebarCollapsed && <div className="text-xs text-slate-400 mb-2 truncate">{user.email}</div>}
                                <button onClick={() => window.location.reload()} className="w-full bg-red-600 py-2 rounded text-xs font-bold hover:bg-red-700 transition flex items-center justify-center gap-2"><i data-lucide="log-out" className="w-4 h-4"></i> {!isSidebarCollapsed && 'Logout'}</button>
                            </div>
                        </aside>
                        
                        <main className="flex-1 overflow-y-auto p-6 relative">
                            {/* GLOBAL FILTERS (Only show on data tabs) */}
                            {['dashboard', 'dppk', 'monthly', 'rab'].includes(activeTab) && (
                                <div className="flex flex-col xl:flex-row gap-4 mb-6 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                    <div className="relative flex-1"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><i data-lucide="search" className="w-4 h-4"></i></div><input type="text" placeholder="Cari data..." className="block w-full pl-10 pr-3 py-2.5 border border-slate-300 rounded-lg bg-slate-50 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm outline-none transition" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
                                    <div className="relative min-w-[180px]"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><i data-lucide="building" className="w-4 h-4"></i></div><select className="block w-full pl-10 pr-8 py-2.5 border border-slate-300 rounded-lg bg-slate-50 focus:ring-indigo-500 sm:text-sm outline-none cursor-pointer" value={selectedUnit} onChange={(e) => setSelectedUnit(e.target.value)}><option value="">Semua Unit Kerja</option>{uniqueUnits.map((unit, idx) => <option key={idx} value={unit}>{unit}</option>)}</select></div>
                                    <div className="relative min-w-[180px]"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><i data-lucide="user" className="w-4 h-4"></i></div><select className="block w-full pl-10 pr-8 py-2.5 border border-slate-300 rounded-lg bg-slate-50 focus:ring-indigo-500 sm:text-sm outline-none cursor-pointer" value={selectedPIC} onChange={(e) => setSelectedPIC(e.target.value)}><option value="">Semua PIC</option>{uniquePICs.map((pic, idx) => <option key={idx} value={pic}>{pic}</option>)}</select></div>
                                    <div className="relative min-w-[180px]"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><i data-lucide="map" className="w-4 h-4"></i></div><select className="block w-full pl-10 pr-8 py-2.5 border border-slate-300 rounded-lg bg-slate-50 focus:ring-indigo-500 sm:text-sm outline-none cursor-pointer" value={selectedWilayah} onChange={(e) => setSelectedWilayah(e.target.value)}><option value="">Semua Wilayah</option>{uniqueWilayahs.map((wil, idx) => <option key={idx} value={wil}>{wil}</option>)}</select></div>
                                    <div className="relative min-w-[180px]"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><i data-lucide="calendar" className="w-4 h-4"></i></div><select className="block w-full pl-10 pr-8 py-2.5 border border-slate-300 rounded-lg bg-slate-50 focus:ring-indigo-500 sm:text-sm outline-none cursor-pointer" value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)}><option value="">Semua Bulan</option>{monthOptions.map((month, idx) => <option key={idx} value={idx}>{month}</option>)}</select></div>
                                    {(selectedUnit || selectedPIC || selectedWilayah || selectedMonth) && <button onClick={() => {setSelectedUnit(''); setSelectedPIC(''); setSelectedWilayah(''); setSelectedMonth(''); setSearchTerm('');}} className="px-4 py-2.5 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 text-sm font-medium transition flex items-center gap-2"><i data-lucide="x" className="w-4 h-4"></i> Reset</button>}
                                </div>
                            )}

                            {activeTab === 'dashboard' && <DashboardView dataDPPK={dataDPPK} />}
                            {activeTab === 'ai-chat' && <AIChatView dataDPPK={dataDPPK} dataRAB={dataRAB} geminiToken={geminiToken} />}
                            {activeTab === 'dppk' && <DPPKTable data={dataDPPK} onSelect={setSelectedActivity} />}
                            {activeTab === 'monthly' && <MonthlyTable data={dataDPPK} rawRAB={dataRAB} />}
                            {activeTab === 'rab' && <RABTable data={dataRAB} />}
                            {activeTab === 'calendar' && <CalendarView events={dataDPPK} setSelectedActivity={setSelectedActivity} />}
                            {activeTab === 'setting' && (
                                <div>
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6">
                                        <h2 className="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2"><i data-lucide="database" className="w-5 h-5 text-indigo-600"></i> Sumber Data (CSV)</h2>
                                        <div className="space-y-4">
                                            <div><label className="block text-sm font-medium text-slate-600 mb-1">URL Data DPPK</label><input className="w-full border border-slate-300 p-2.5 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm" value={config.dppk} onChange={e => setConfig({...config, dppk: e.target.value})} /></div>
                                            <div><label className="block text-sm font-medium text-slate-600 mb-1">URL Data RAB</label><input className="w-full border border-slate-300 p-2.5 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm" value={config.rab} onChange={e => setConfig({...config, rab: e.target.value})} /></div>
                                            <div className="flex justify-end"><button onClick={() => {localStorage.setItem('dppk_url', config.dppk); localStorage.setItem('rab_url', config.rab); window.location.reload();}} className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition font-bold text-sm">Simpan & Muat Ulang</button></div>
                                        </div>
                                    </div>
                                    <WhitelistSettings />
                                </div>
                            )}
                        </main>
                     </div>
                     {selectedActivity && <ActivityDetailModal activity={selectedActivity} rabItems={getRABForActivity(selectedActivity.kegiatan)} onClose={() => setSelectedActivity(null)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>